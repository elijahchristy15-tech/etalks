<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verified Chat App</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { box-sizing: border-box; }
.message-bubble { animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
.send-animation { animation: sendPulse 0.2s ease-out; }
@keyframes sendPulse { 0% { transform: scale(1);} 50% { transform: scale(0.95);} 100% { transform: scale(1);} }
</style>
</head>
<body class="h-full bg-gray-100 text-gray-900">
<main class="h-full flex flex-col max-w-2xl mx-auto p-6">

  <header class="text-center mb-4">
    <h1 class="text-3xl font-bold">Verified Chat App</h1>
  </header>

  <!-- Login/Register -->
  <div id="login-container" class="mb-6">
    <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-2 border rounded"/>
    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">Register / Login</button>
  </div>

  <!-- Admin pending list -->
  <div id="admin-container" class="mb-6 hidden">
    <h2 class="text-xl font-semibold mb-2">Pending Users</h2>
    <div id="pending-list" class="space-y-2"></div>
  </div>

  <!-- Messages -->
  <div id="chat-container" class="hidden flex-1 flex flex-col">
    <div id="messages-container" class="flex-1 mb-6 overflow-y-auto space-y-4 min-h-32"></div>
    <div id="message-form-container" class="flex gap-3 items-end">
      <textarea id="message-input" rows="1" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-xl border-2 border-gray-300 resize-none"></textarea>
      <button id="send-button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>Send</button>
    </div>
  </div>

</main>

<script>
const API_BASE = "https://68fa9042ef8b2e621e80547a.mockapi.io/api/v1";
const API_USERS = `${API_BASE}/users`;
const API_MESSAGES = `${API_BASE}/messages`;

let currentUser = null;

// --- Login/Register ---
document.getElementById('login-btn').addEventListener('click', async () => {
  const username = document.getElementById('username').value.trim();
  if(!username) return alert("Enter a username");

  // Check if user exists
  const res = await fetch(`${API_USERS}?name=${username}`);
  const users = await res.json();

  if(users.length > 0){
    const user = users[0];
    if(!user.approved) return alert("Your registration is pending approval!");
    currentUser = user;
    initChat();
  } else {
    // New user -> add to pending (approved: false)
    const avatarId = Math.floor(Math.random()*100);
    const newUserRes = await fetch(API_USERS, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({name: username, approved: false, avatar:`https://cdn.jsdelivr.net/gh/faker-js/assets-person-portrait/male/512/${avatarId}.jpg`})
    });
    const newUser = await newUserRes.json();
    alert("Your registration is pending approval!");
    // Optionally refresh admin view
    loadPendingUsers();
  }
});

// --- Admin functions ---
function showAdminPanel() {
  document.getElementById('admin-container').classList.remove('hidden');
  loadPendingUsers();
}

async function loadPendingUsers() {
  const res = await fetch(API_USERS);
  const users = await res.json();
  const pending = users.filter(u => !u.approved);
  const container = document.getElementById('pending-list');
  container.innerHTML = '';
  pending.forEach(u => {
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center bg-gray-200 p-2 rounded';
    div.innerHTML = `<span>${u.name}</span>
      <div>
        <button class="bg-green-500 hover:bg-green-600 text-white px-2 rounded mr-1" onclick="approveUser('${u.id}')">Approve</button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 rounded" onclick="denyUser('${u.id}')">Deny</button>
      </div>`;
    container.appendChild(div);
  });
}

async function approveUser(id){
  const res = await fetch(`${API_USERS}/${id}`);
  const user = await res.json();
  await fetch(`${API_USERS}/${id}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({...user, approved:true})
  });
  loadPendingUsers();
}

async function denyUser(id){
  await fetch(`${API_USERS}/${id}`, {method:"DELETE"});
  loadPendingUsers();
}

// --- Initialize chat ---
function initChat(){
  document.getElementById('login-container').classList.add('hidden');
  document.getElementById('chat-container').classList.remove('hidden');
  if(currentUser.name.toLowerCase() === "eli") showAdminPanel();

  loadMessages();
}

// --- Load messages ---
async function loadMessages(){
  const res = await fetch(API_MESSAGES);
  const messages = await res.json();
  const container = document.getElementById('messages-container');
  container.innerHTML = '';
  messages.forEach(createMessageBubble);
  container.scrollTop = container.scrollHeight;
}

// --- Send message ---
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

messageInput.addEventListener('input', () => {
  sendButton.disabled = !messageInput.value.trim();
});

sendButton.addEventListener('click', async () => {
  const text = messageInput.value.trim();
  if(!text) return;

  const res = await fetch(API_MESSAGES, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({user: currentUser.name, text, timestamp: Date.now()})
  });
  const msg = await res.json();
  createMessageBubble(msg);

  messageInput.value = '';
  sendButton.disabled = true;
});

// --- Display message ---
function createMessageBubble(msg){
  const container = document.getElementById('messages-container');
  const div = document.createElement('div');
  div.className = 'message-bubble flex gap-2 items-end';

  const avatar = document.createElement('img');
  avatar.src = currentUser.avatar;
  avatar.className = 'w-8 h-8 rounded-full';

  const bubble = document.createElement('div');
  bubble.className = 'px-4 py-2 rounded-2xl bg-blue-600 text-white max-w-xs break-words';
  bubble.innerHTML = `<strong>${msg.user}</strong><br>${msg.text}<div class="text-xs opacity-75 mt-1">${new Date(msg.timestamp).toLocaleTimeString()}</div>`;

  div.appendChild(avatar);
  div.appendChild(bubble);
  container.appendChild(div);

  container.scrollTop = container.scrollHeight;
}

// --- Refresh messages every 3 seconds ---
setInterval(() => {
  if(currentUser && currentUser.approved) loadMessages();
}, 3000);

</script>
</body>
</html>
